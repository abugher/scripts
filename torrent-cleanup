#!/bin/bash
# torrent-cleanup

ssh_target=ansible@files
credentials=transmission:$(pass show shared/transmission)
watch_dir=/storage/bittorrent/torrents
content_dir=/storage/bittorrent/content/
now="$(date +%s)"


function main {
  # These aren't torrents, but shouldn't be deleted.
  exceptions=(
    "radio.m3u"
    "nightvale"
  )
  names=( "${exceptions[@]}" )
  files=()
  orphans=()

  while read name; do
    names+=( "${name}" )
  done < <(
    ssh "${ssh_target}" transmission-remote -n "${credentials}" -l \
      | sed -E 's/([^ ]* *){10}//' \
      | sort
  )

  while read file; do
    files+=( "${file}" )
  done < <(
    ssh "${ssh_target}" ls "${content_dir}" \
      | sort
  )

  for file in "${files[@]}"; do
    orphan="yes"
    for name in "${names[@]}"; do
      if test "${file}" == "${name}"; then
        orphan="no"
        # Searching may be optimized by removing already matched names from the array.
        break
      fi
    done
    
    if test "yes" = "${orphan}"; then
      orphans+=( "${file}" )
    fi
  done

  for orphan in "${orphans[@]}"; do
    printf 'orphan:  %s\n' "${orphan}"
  done

}


main "${@}"
