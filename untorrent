#!/bin/bash
# untorrent { regex }
#
# "Torrent that thing!"

xmessageOptions="-center -buttons OK:0 -default OK"
ssh_target=ansible@files
credentials=transmission:$(pass show shared/transmission)
watch_dir=/storage/bittorrent/torrents
now="$(date +%s)"


function main {
  string="${1}"

  if test '' = "${string}"; then
    echo "Empty argument matches everything.  Don't delete everything.  C'mon." >&2
    exit 1
  fi

  indices=( $(
    ssh "${ssh_target}" transmission-remote -n "${credentials}" -l \
      | grep -iE "${string}" \
      | awk '{print $1}'
  ) )

  for index in "${indices[@]}"; do
    if test '' = "${index}"; then continue; fi
    echo "Analyzing:  '${index}'"
    ssh "${ssh_target}" transmission-remote -n "${credentials}" -t "${index}" --remove-and-delete
  done;
}


function succeed {
  type="${1}"
  string="${2}"
  xmessage -timeout 2 ${xmessageOptions} "Successfully added ${type}:

  ${string}

"
}


function fail {
  type="${1}"
  string="${2}"
  ret="${3}"
  message="${4}"
  xmessage ${xmessageOptions} "Error:  Attempt to add ${type} returned status:  ${ret}

Target:

  ${string}

Message:

  ${message}
"

exit 1
}


main "${@}"
